<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MULINHUA ÊúãÂèãÂúà</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f7f8fa;
      --text-color: #222;
      --card-bg: #fff;
      --header-bg: #fff;
      --border-color: #e0e0e0;
      --primary-color: #1a73e8;
      --hover-color: #155ab6;
      --success-color: #4CAF50;
      --warning-color: #FFC107;
      --error-color: #e53935;
    }

    .dark-mode {
      --bg-color: #121212;
      --text-color: #f0f0f0;
      --card-bg: #1e1e1e;
      --header-bg: #1e1e1e;
      --border-color: #444;
      --primary-color: #64b5f6;
      --hover-color: #90caf9;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    
    header {
      background: var(--header-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .logo {
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 2px;
      color: var(--primary-color);
    }
    
    .admin-btn, .notify-btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 1rem;
      transition: background 0.2s;
    }
    
    .admin-btn:hover, .notify-btn:hover {
      background: var(--hover-color);
    }
    
    main {
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .post {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      margin-bottom: 1.5rem;
      padding: 1.2rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    
    .post-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .post .author {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.1rem;
      cursor: pointer;
    }
    
    .post .time {
      color: #888;
      font-size: 0.85rem;
    }
    
    .post .content {
      font-size: 1.05rem;
      line-height: 1.7;
    }
    
    .post img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    
    .post-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .action-btn.liked {
      color: var(--error-color);
    }
    
    .action-btn.faved {
      color: var(--warning-color);
    }
    
    .comments {
      margin-top: 0.8rem;
      border-top: 1px solid var(--border-color);
      padding-top: 0.8rem;
    }
    
    .comment {
      margin-bottom: 0.6rem;
      padding: 0.4rem 0.6rem;
      background: rgba(0,0,0,0.03);
      border-radius: 6px;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    
    .comment-user {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .comment-time {
      color: #888;
    }
    
    .comment-text {
      margin-top: 4px;
    }
    
    .comment-form {
      display: flex;
      margin-top: 0.8rem;
      gap: 8px;
    }
    
    .comment-input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .comment-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
    }
    
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .filter-btn {
      padding: 6px 12px;
      background: rgba(0,0,0,0.05);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .search-bar {
      display: flex;
      margin-bottom: 1.5rem;
    }
    
    .search-input {
      flex-grow: 1;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px 0 0 20px;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .search-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 20px 20px 0;
      padding: 8px 16px;
      cursor: pointer;
    }
    
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 99;
    }
    
    @media (max-width: 700px) {
      main { max-width: 100%; }
      header { padding: 1rem; }
      .post-actions { flex-wrap: wrap; }
    }
    
    .admin-panel {
      display: none;
      flex-direction: column;
      gap: 1rem;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .admin-panel input, .admin-panel textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .admin-panel label {
      font-weight: 600;
      margin-bottom: 0.3rem;
      display: block;
    }
    
    .admin-panel .submit-btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .admin-panel .submit-btn:hover {
      background: var(--hover-color);
    }
    
    .delete-btn {
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .poll-status {
      position: fixed;
      bottom: 80px;
      right: 20px;
      padding: 8px 15px;
      background: rgba(0,0,0,0.75);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 100;
      display: flex;
      align-items: center;
    }
    
    .poll-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .poll-active { background: var(--success-color); }
    .poll-idle { background: var(--warning-color); }
  </style>
</head>
<body>
  <header>
    <span class="logo">MULINHUA ÊúãÂèãÂúà</span>
    <div>
      <button class="notify-btn" onclick="requestNotify()">
        üîî<span id="notifyCount" style="font-size:0.9em;background:var(--error-color);color:#fff;border-radius:50%;padding:0 6px;margin-left:4px;display:none;">0</span>
      </button>
      <button class="admin-btn" id="memberBtn" onclick="showMemberCenter()">‰ºöÂëò‰∏≠ÂøÉ</button>
      <button class="admin-btn" id="loginBtn" onclick="showUserLoginModal()">ÁôªÂΩï/Ê≥®ÂÜå</button>
      <button class="admin-btn" id="adminBtn" onclick="showLoginModal()">ÁÆ°ÁêÜÂëòÂÖ•Âè£</button>
      <button class="admin-btn" id="logoutBtn" style="display:none;" onclick="logoutAdmin()">ÈÄÄÂá∫ÁôªÂΩï</button>
    </div>
  </header>
  <main>
    <div class="admin-panel" id="adminPanel">
      <form id="postForm" onsubmit="return submitPost(event)">
        <label>ÂÜÖÂÆπ</label>
        <textarea id="postContent" rows="3" required placeholder="ËØ∑ËæìÂÖ•ÂÜÖÂÆπ..."></textarea>
        <label>ÂõæÁâáÔºàÂèØÈÄâÔºâ</label>
        <input type="file" id="postImage" accept="image/*">
        <button class="submit-btn" type="submit">ÂèëÂ∏É</button>
      </form>
      <div style="margin-top:1.2rem;">
        <label>ÂØºÂÖ•Âä®ÊÄÅÔºàmmts.txtÔºâ</label>
        <input type="file" id="mmtsFile" accept=".txt" onchange="importMmtsFile(event)">
        <span style="color:#888;font-size:0.95em;">‰ªÖÁÆ°ÁêÜÂëòÂèØÁî®ÔºåÂÜÖÂÆπÊ†ºÂºè‰∏∫JSONÊï∞ÁªÑ</span>
      </div>
    </div>
    
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Âä®ÊÄÅÊàñÁî®Êà∑...">
      <button class="search-btn" onclick="searchPosts()">ÊêúÁ¥¢</button>
    </div>
    
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterFeed('all')">ÂÖ®ÈÉ®</button>
      <button class="filter-btn" onclick="filterFeed('following')">ÂÖ≥Ê≥®</button>
      <button class="filter-btn" onclick="filterFeed('popular')">ÁÉ≠Èó®</button>
    </div>
    
    <div id="feed">
      <!-- Âä®ÊÄÅÂÜÖÂÆπÊµÅ -->
    </div>
  </main>
  
  <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
  
  <!-- ËΩÆËØ¢Áä∂ÊÄÅÊåáÁ§∫Âô® -->
  <div class="poll-status" id="pollStatus">
    <div class="poll-dot poll-active" id="pollDot"></div>
    <span id="pollText">ËΩÆËØ¢‰∏≠...</span>
  </div>
  
  <!-- Áî®Êà∑ÁôªÂΩï/Ê≥®ÂÜåÂºπÁ™ó -->
  <div id="userLoginModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:101;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">Áî®Êà∑ÁôªÂΩï/Ê≥®ÂÜå</div>
      <input id="userLoginUser" type="text" placeholder="Áî®Êà∑Âêç/ÊâãÊú∫Âè∑/ÈÇÆÁÆ±" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <input id="userLoginPwd" type="password" placeholder="ÂØÜÁ†Å" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <div id="userLoginError" style="color:var(--error-color);font-size:0.98rem;display:none;"></div>
      <button class="submit-btn" onclick="return userLogin(event)">ÁôªÂΩï</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeUserLoginModal();return false;">ÂèñÊ∂à</button>
      <div style="text-align:center;color:#888;font-size:0.98rem;">Êàñ‰ΩøÁî®Á§æ‰∫§Ë¥¶Âè∑ÁôªÂΩï</div>
      <div style="display:flex;gap:1rem;justify-content:center;">
        <button class="submit-btn" style="background:#07c160;" onclick="socialLogin('wechat')">ÂæÆ‰ø°</button>
        <button class="submit-btn" style="background:#498ad5;" onclick="socialLogin('qq')">QQ</button>
        <button class="submit-btn" style="background:#e6162d;" onclick="socialLogin('weibo')">ÂæÆÂçö</button>
      </div>
    </div>
  </div>
  
  <!-- ‰ºöÂëò‰∏≠ÂøÉÂºπÁ™ó -->
  <div id="memberCenterModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:102;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">‰ºöÂëò‰∏≠ÂøÉ</div>
      <div id="memberInfo">ËØ∑ÂÖàÁôªÂΩï</div>
      <div style="margin-top:1rem;">
        <h3>ÊàëÁöÑÂÖ≥Ê≥®</h3>
        <div id="followingList" style="margin-top:0.5rem;"></div>
      </div>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeMemberCenter();return false;">ÂÖ≥Èó≠</button>
    </div>
  </div>
  
  <!-- ÁÆ°ÁêÜÂëòÁôªÂΩïÂºπÁ™ó -->
  <div id="loginModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:100;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">ÁÆ°ÁêÜÂëòÁôªÂΩï</div>
      <input id="loginUser" type="text" placeholder="Ë¥¶Êà∑" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <input id="loginPwd" type="password" placeholder="ÂØÜÁ†Å" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <div id="loginError" style="color:var(--error-color);font-size:0.98rem;display:none;"></div>
      <button class="submit-btn" onclick="return loginAdmin(event)">ÁôªÂΩï</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeLoginModal();return false;">ÂèñÊ∂à</button>
    </div>
  </div>
  
  <!-- Áî®Êà∑ËµÑÊñôÂºπÁ™ó -->
  <div id="userProfileModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:103;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:300px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">Áî®Êà∑ËµÑÊñô</div>
      <div id="profileName"></div>
      <button class="submit-btn" onclick="followUser(currentProfile)">ÂÖ≥Ê≥®</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeUserProfile();return false;">ÂÖ≥Èó≠</button>
    </div>
  </div>
  
  <script>
    // ËΩÆËØ¢Áõ∏ÂÖ≥ÂèòÈáè
    let pollInterval = null;
    let lastPollTime = Date.now();
    let lastPostCount = 0;
    const POLL_INTERVAL = 10 * 60 * 1000; // 10ÂàÜÈíüÁöÑÊØ´ÁßíÊï∞
    let currentFilter = 'all';
    let filteredPosts = [];
    let currentProfile = null;
    
    // Á§∫‰æãÂä®ÊÄÅÊï∞ÊçÆ
    let demoPosts = [
      {
        id: 1,
        author: 'ÁÆ°ÁêÜÂëò',
        content: 'Ê¨¢ËøéÊù•Âà∞ MULINHUA ÊúãÂèãÂúàÔºÅ',
        image: '',
        time: new Date(Date.now() - 300000).toISOString(),
        likes: 12,
        favs: 5
      },
      {
        id: 2,
        author: 'ÁÆ°ÁêÜÂëò',
        content: 'ÊîØÊåÅÊâãÊú∫Êé®ÈÄÅÈÄöÁü•ÔºåËÆ∞ÂæóÁÇπÂáª‰∏äÊñπÊåâÈíÆËé∑ÂèñÊùÉÈôê„ÄÇ',
        image: '',
        time: new Date(Date.now() - 600000).toISOString(),
        likes: 8,
        favs: 3
      }
    ];
    let lastImportedMmts = '';
    
    // ÂàÜÈ°µ/Êó†ÈôêÊªöÂä®ÂèÇÊï∞
    let pageSize = 5;
    let currentPage = 1;
    let isLoading = false;
    function getPagedPosts() {
      let posts = getCurrentPosts();
      return posts.slice(0, currentPage * pageSize);
    }
    // ËΩÆËØ¢Áä∂ÊÄÅÊéßÂà∂
    function updatePollStatus(active) {
      const pollDot = document.getElementById('pollDot');
      const pollText = document.getElementById('pollText');
      
      if (active) {
        pollDot.className = 'poll-dot poll-active';
        pollText.textContent = 'ËΩÆËØ¢‰∏≠...';
      } else {
        pollDot.className = 'poll-dot poll-idle';
        const elapsed = Math.floor((Date.now() - lastPollTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        pollText.textContent = `${minutes}ÂàÜ${seconds}ÁßíÂêéÂ∞ÜËΩÆËØ¢`;
      }
    }
    
    // ÂàùÂßãÂåñËΩÆËØ¢
    function initPolling() {
      lastPostCount = demoPosts.length;
      
      // ÂêØÂä®ËΩÆËØ¢ÂÆöÊó∂Âô®
      pollInterval = setInterval(checkForNewPosts, POLL_INTERVAL);
      updatePollStatus(true);
      
      // È°µÈù¢ÂèØËßÅÊÄß‰∫ã‰ª∂ÁõëÂê¨Âô®
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
          // È°µÈù¢ÂèØËßÅÊó∂Á´ãÂç≥Ê£ÄÊü•
          checkForNewPosts();
          if (!pollInterval) {
            pollInterval = setInterval(checkForNewPosts, POLL_INTERVAL);
          }
          updatePollStatus(true);
        } else {
          // È°µÈù¢‰∏çÂèØËßÅÊó∂ÊöÇÂÅúËΩÆËØ¢
          clearInterval(pollInterval);
          pollInterval = null;
          updatePollStatus(false);
        }
      });
      
      // ÂàùÂßãÊ£ÄÊü•‰∏ÄÊ¨°
      checkForNewPosts();
    }
    
    // Ê£ÄÊü•Êñ∞Â∏ñÂ≠êÁöÑÂáΩÊï∞
    function checkForNewPosts() {
      lastPollTime = Date.now();
      updatePollStatus(false);
      
      console.log(`[${new Date().toLocaleTimeString()}] ËΩÆËØ¢Ê£ÄÊü•Êñ∞Ê∂àÊÅØ...`);
      
      const currentPostCount = demoPosts.length;
      if (currentPostCount > lastPostCount) {
        const newPostCount = currentPostCount - lastPostCount;
        lastPostCount = currentPostCount;
        
        // Êõ¥Êñ∞ÈÄöÁü•ËÆ°Êï∞
        updateNotifyCount(newPostCount);
        
        // ÂèëÈÄÅÈÄöÁü•
        if (Notification.permission === 'granted') {
          new Notification('ÊúâÊñ∞Âä®ÊÄÅÂèëÂ∏É', {
            body: `ÁÆ°ÁêÜÂëòÂèëÂ∏É‰∫Ü${newPostCount}Êù°Êñ∞Ê∂àÊÅØ`,
            icon: '/favicon.ico'
          });
        }
        
        console.log(`Ê£ÄÊµãÂà∞${newPostCount}Êù°Êñ∞Ê∂àÊÅØ`);
        
        // Âà∑Êñ∞Âä®ÊÄÅÊµÅ
        renderFeed();
      } else {
        console.log('Ê≤°ÊúâÂèëÁé∞Êñ∞Âä®ÊÄÅ');
      }
    }
    
    // Êõ¥Êñ∞ÈÄöÁü•ËÆ°Êï∞
    function updateNotifyCount(count) {
      const notifyCountElement = document.getElementById('notifyCount');
      notifyCountElement.textContent = count;
      notifyCountElement.style.display = count > 0 ? 'inline-block' : 'none';
    }
    
    // ÁÆ°ÁêÜÂëòÈù¢ÊùøÊòæÁ§∫/ÈöêËóè
    function toggleAdminPanel() {
      const panel = document.getElementById('adminPanel');
      panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }
    
    // Ëé∑ÂèñÈÄöÁü•ÊùÉÈôê
    function requestNotify() {
      if (!('Notification' in window)) {
        alert('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÈÄöÁü•ÂäüËÉΩ');
        return;
      }
      
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          alert('ÈÄöÁü•ÊùÉÈôêÂ∑≤Ëé∑ÂèñÔºÅ');
        } else {
          alert('ÈÄöÁü•ÊùÉÈôêË¢´ÊãíÁªù');
        }
      });
    }
    
    // ÂØºÂÖ•mmts.txtÊñá‰ª∂Âπ∂Ëß£Êûê‰∏∫Âä®ÊÄÅÊµÅ
    function importMmtsFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const txt = evt.target.result;
          if (txt === lastImportedMmts) {
            alert('ÂÜÖÂÆπÊú™ÂèòÂåñ');
            return;
          }
          const arr = JSON.parse(txt);
          if (!Array.isArray(arr)) throw new Error('Ê†ºÂºèÈîôËØØ');
          demoPosts = arr;
          lastImportedMmts = txt;
          renderFeed();
          lastPostCount = demoPosts.length;
          if (window.Notification && Notification.permission === 'granted') {
            new Notification('Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞', { body: 'Â∑≤ÂØºÂÖ•ÊúÄÊñ∞Âä®ÊÄÅ', icon: '/favicon.ico' });
          }
        } catch (err) {
          alert('mmts.txtÊ†ºÂºèÈîôËØØÔºåÈúÄ‰∏∫JSONÊï∞ÁªÑÔºÅ');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ÁÆ°ÁêÜÂëòÂèëÂ∏ÉÂÜÖÂÆπ
    function submitPost(e) {
      e.preventDefault();
      const content = document.getElementById('postContent').value.trim();
      const imageInput = document.getElementById('postImage');
      if (!content) return false;
      
      function notifyNewPost(text) {
        if (window.Notification && Notification.permission === 'granted') {
          new Notification('Êñ∞Âä®ÊÄÅ', {
            body: text.length > 40 ? text.slice(0, 40) + '...' : text,
            icon: '/favicon.ico'
          });
        }
      }
      
      const newPost = {
        id: demoPosts.length + 1,
        author: 'ÁÆ°ÁêÜÂëò',
        content,
        image: '',
        time: new Date().toISOString(),
        likes: 0,
        favs: 0
      };
      
      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          newPost.image = evt.target.result;
          demoPosts.unshift(newPost);
          renderFeed();
          notifyNewPost(content);
          lastPostCount = demoPosts.length;
          document.getElementById('postForm').reset();
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        demoPosts.unshift(newPost);
        renderFeed();
        notifyNewPost(content);
        lastPostCount = demoPosts.length;
        document.getElementById('postForm').reset();
      }
      
      return false;
    }
    
    // ====== GitHub Âä®ÊÄÅÂêåÊ≠•Áõ∏ÂÖ≥ ======
    const GITHUB_OWNER = 'rover2828'; // TODO: ÊõøÊç¢‰∏∫‰Ω†ÁöÑgithubÁî®Êà∑Âêç
    const GITHUB_REPO = 'mulinhua'; // TODO: ÊõøÊç¢‰∏∫‰Ω†ÁöÑ‰ªìÂ∫ìÂêç
    const GITHUB_FILEPATH = 'Âä®ÊÄÅ/mlh.txt';
    const GITHUB_TOKEN = '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'; // TODO: ÁÆ°ÁêÜÂëòÁ´ØÂ°´ÂÜô‰Ω†ÁöÑtokenÔºåÂâçÁ´ØÁîü‰∫ßÁéØÂ¢ÉËØ∑ÂãøÊö¥Èú≤token

    // Ëé∑ÂèñÂä®ÊÄÅÔºàmlh.txtÔºâ
    async function fetchGithubPosts() {
      try {
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}?t=${Date.now()}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3.raw' } });
        if (!res.ok) throw new Error('Ëé∑ÂèñÂä®ÊÄÅÂ§±Ë¥•');
        const txt = await res.text();
        const arr = JSON.parse(txt);
        if (Array.isArray(arr)) {
          demoPosts = arr;
          lastImportedMmts = txt;
          filteredPosts = [];
          resetPaging();
          renderFeed();
        }
      } catch (e) {
        alert('Êó†Ê≥ï‰ªéGitHubËé∑ÂèñÂä®ÊÄÅÔºö' + e.message);
      }
    }
    // ÁÆ°ÁêÜÂëòÂèëÂ∏ÉÂÜÖÂÆπÊó∂ÂêåÊ≠•Âà∞GitHub
    async function pushGithubPosts() {
      if (!GITHUB_TOKEN) return; // Êú™ÈÖçÁΩÆtoken‰∏çÊé®ÈÄÅ
      try {
        // ÂÖàËé∑Âèñsha
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}`;
        const res = await fetch(url, { headers: { 'Authorization': 'token ' + GITHUB_TOKEN } });
        const data = await res.json();
        const sha = data.sha;
        // Êõ¥Êñ∞ÂÜÖÂÆπ
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(demoPosts, null, 2))));
        const body = {
          message: 'ÂèëÂ∏ÉÊñ∞Âä®ÊÄÅ',
          content,
          sha
        };
        const putRes = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': 'token ' + GITHUB_TOKEN,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (!putRes.ok) throw new Error('Êé®ÈÄÅÂ§±Ë¥•');
      } catch (e) {
        alert('ÂêåÊ≠•Âà∞GitHubÂ§±Ë¥•Ôºö' + e.message);
      }
    }
    // ‰øÆÊîπÁÆ°ÁêÜÂëòÂèëÂ∏ÉÈÄªËæëÔºåÂèëÂ∏ÉÂêéÂêåÊ≠•
    const originSubmitPost = submitPost;
    submitPost = async function(e) {
      const ret = originSubmitPost(e);
      if (isAdminLoggedIn()) {
        await pushGithubPosts();
      }
      return ret;
    }
    // È°µÈù¢Âä†ËΩΩÊó∂È¢ÑÂä†ËΩΩGitHubÂä®ÊÄÅ
    window.addEventListener('DOMContentLoaded', function() {
      fetchGithubPosts();
    });
    // Ê∑ªÂä†Âà∑Êñ∞ÊåâÈíÆ
    document.addEventListener('DOMContentLoaded', function() {
      const header = document.querySelector('header > div');
      const refreshBtn = document.createElement('button');
      refreshBtn.className = 'admin-btn';
      refreshBtn.textContent = 'Âà∑Êñ∞';
      refreshBtn.onclick = function() { fetchGithubPosts(); };
      header.appendChild(refreshBtn);
    });
    
    // Êó∂Èó¥Ê†ºÂºèÂåñ
    function formatTime(time) {
      const now = new Date();
      const postDate = new Date(time);
      const diffSec = Math.floor((now - postDate) / 1000);
      
      if (diffSec < 60) return 'ÂàöÂàö';
      if (diffSec < 3600) return `${Math.floor(diffSec/60)}ÂàÜÈíüÂâç`;
      if (diffSec < 86400) return `${Math.floor(diffSec/3600)}Â∞èÊó∂Ââç`;
      return `${postDate.getMonth()+1}Êúà${postDate.getDate()}Êó•`;
    }
    
    // Âä®ÊÄÅÁ≠õÈÄâ
    function filterFeed(type) {
      resetPaging();
      currentFilter = type;
      
      // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === 
          (type === 'all' ? 'ÂÖ®ÈÉ®' : type === 'following' ? 'ÂÖ≥Ê≥®' : 'ÁÉ≠Èó®'));
      });
      
      filteredPosts = [];
      renderFeed();
    }
    
    // ÊêúÁ¥¢ÂäüËÉΩ
    function searchPosts() {
      resetPaging();
      const term = document.getElementById('searchInput').value.trim().toLowerCase();
      const feed = document.getElementById('feed');
      if (!term) {
        renderFeed();
        return;
      }
      const keywords = term.split(/\s+/).filter(Boolean);
      const results = demoPosts.filter(post => {
        const text = (post.content + ' ' + post.author + ' ' + (post.comments ? post.comments.map(c => c.text + ' ' + c.user).join(' ') : '')).toLowerCase();
        return keywords.every(kw => text.includes(kw));
      });
      filteredPosts = results;
      renderFeed();
    }
    // È´ò‰∫ÆÂÖ≥ÈîÆËØçÂíå@Áî®Êà∑
    function highlightKeywords(text, keywords) {
      if (!text) return '';
      text = text.replace(/@([\u4e00-\u9fa5\w\-]+)/g, '<span style="color:var(--primary-color);font-weight:bold;">@$1</span>');
      keywords.forEach(kw => {
        if (!kw) return;
        const reg = new RegExp(kw.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'gi');
        text = text.replace(reg, m => `<mark style=\"background:var(--warning-color);color:#222;\">${m}</mark>`);
      });
      return text;
    }
    // ËØÑËÆ∫ÁÇπËµû
    function likeComment(postIdx, commentIdx) {
      if (!demoPosts[postIdx].comments[commentIdx].likes) demoPosts[postIdx].comments[commentIdx].likes = 0;
      demoPosts[postIdx].comments[commentIdx].likes++;
      const el = document.getElementById(`comment-like-${demoPosts[postIdx].id}-${commentIdx}`);
      if (el) el.textContent = demoPosts[postIdx].comments[commentIdx].likes;
    }
    // ÂõæÁâáÈ¢ÑËßàÂºπÁ™ó
    function previewImage(src, e) {
      e.stopPropagation();
      let modal = document.getElementById('imgPreviewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imgPreviewModal';
        modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:200;display:flex;align-items:center;justify-content:center;';
        modal.onclick = function() { modal.style.display = 'none'; };
        document.body.appendChild(modal);
      }
      modal.innerHTML = `<img src='${src}' style='max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;'>`;
      modal.style.display = 'flex';
    }
    // ÂàÜÈ°µÊ∏≤ÊüìÂä®ÊÄÅÊµÅ
    function renderFeed() {
      const feed = document.getElementById('feed');
      let postsToShow = getPagedPosts();
      let keywords = document.getElementById('searchInput').value.trim().toLowerCase().split(/\s+/).filter(Boolean);
      let html = '';
      if (postsToShow.length === 0) {
        html = '<div class="post"><div class="content">ÊöÇÊó†Âä®ÊÄÅ</div></div>';
      } else {
        postsToShow.forEach((post, idx) => {
          const isLiked = localStorage.getItem(`liked_${post.id}`) === 'true';
          const isFaved = localStorage.getItem(`faved_${post.id}`) === 'true';
          let safeImg = post.image ? post.image.replace(/'/g, "&#39;") : '';
          let imageHtml = post.image ? `<img src="${post.image}" style="cursor:zoom-in;" onclick=\"previewImage('${safeImg}', event)\">` : '';
          let content = highlightKeywords(post.content, keywords);
          let author = highlightKeywords(post.author, keywords);
          html += `
            <div class="post">
              <div class="post-header">
                <div class="author" onclick="showUserProfile('${post.author}')">${author}</div>
                <div class="time">${formatTime(post.time)}</div>
              </div>
              <div class="content">${content}</div>
              ${imageHtml}
              <div class="post-actions">
                <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="likePost(${idx})">üëç ${post.likes || 0}</button>
                <button class="action-btn ${isFaved ? 'faved' : ''}" onclick="favPost(${idx})">‚≠ê ${post.favs || 0}</button>
                <button class="action-btn" onclick="sharePost(${idx})">‚ÜóÔ∏è ÂàÜ‰∫´</button>
                ${isAdminLoggedIn() ? `<button class="delete-btn" onclick="deletePost(${idx})">Âà†Èô§</button>` : ''}
              </div>
              ${post.comments && post.comments.length > 0 ? `
                <div class="comments">
                  ${post.comments.map((comment, cidx) => `
                    <div class="comment">
                      <div class="comment-header">
                        <div class="comment-user">${highlightKeywords(comment.user, keywords)}</div>
                        <div class="comment-time">${formatTime(comment.time)}</div>
                        <button class="action-btn comment-like-btn" onclick="likeComment(${idx},${cidx})">üëç <span id='comment-like-${post.id}-${cidx}'>${comment.likes||0}</span></button>
                      </div>
                      <div class="comment-text">${highlightKeywords(comment.text, keywords)}</div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <form class="comment-form" onsubmit="return addComment(event, ${idx})">
                <input type="text" class="comment-input" id="commentInput${idx}" placeholder="Ê∑ªÂä†ËØÑËÆ∫...">
                <button type="submit" class="comment-btn">ÂèëÈÄÅ</button>
              </form>
            </div>
          `;
        });
      }
      // Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ
      if (getCurrentPosts().length > postsToShow.length) {
        html += `<div style='text-align:center;margin:1rem;'><button class='filter-btn' id='loadMoreBtn' onclick='loadMoreFeed()'>Âä†ËΩΩÊõ¥Â§ö</button></div>`;
      }
      feed.innerHTML = html;
    }
    function loadMoreFeed() {
      if (isLoading) return;
      isLoading = true;
      currentPage++;
      renderFeed();
      isLoading = false;
    }
    // Êó†ÈôêÊªöÂä®
    window.addEventListener('scroll', function() {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        if (getCurrentPosts().length > getPagedPosts().length) {
          loadMoreFeed();
        }
      }
    });
    function resetPaging() {
      currentPage = 1;
    }
    // ‰øÆÊîπfilterFeed„ÄÅsetSort„ÄÅclearSearch„ÄÅshowMemberCenterÁ≠âË∞ÉÁî®renderFeedÂâçÂä†resetPaging()
    function filterFeed(type) {
      resetPaging();
      currentFilter = type;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === 
          (type === 'all' ? 'ÂÖ®ÈÉ®' : type === 'following' ? 'ÂÖ≥Ê≥®' : 'ÁÉ≠Èó®'));
      });
      filteredPosts = [];
      renderFeed();
    }
    function setSort(type) {
      resetPaging();
      currentSort = type;
      renderFeed();
    }
    function clearSearch() {
      resetPaging();
      document.getElementById('searchInput').value = '';
      filteredPosts = [];
      renderFeed();
    }
    function showMemberCenter() {
      resetPaging();
      document.getElementById('memberCenterModal').style.display = 'flex';
      updateMemberInfo();
      updateFollowingList();
    }
    // ÁÆ°ÁêÜÂëòÁôªÂΩïÊ†°È™å
function loginAdmin(e) {
  e.preventDefault();
  const user = document.getElementById('loginUser').value.trim();
  const pwd = document.getElementById('loginPwd').value;
  const errorDiv = document.getElementById('loginError');
  if (user === 'rover' && pwd === '1621622968') {
    localStorage.setItem('isAdmin', 'true');
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('logoutBtn').style.display = '';
    document.getElementById('adminPanel').style.display = 'flex';
    errorDiv.style.display = 'none';
    renderFeed && renderFeed();
  } else {
    errorDiv.textContent = 'Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ';
    errorDiv.style.display = 'block';
  }
  return false;
}
// Âà§Êñ≠ÊòØÂê¶Â∑≤ÁôªÂΩïÁÆ°ÁêÜÂëò
function isAdminLoggedIn() {
  return localStorage.getItem('isAdmin') === 'true';
}
function logoutAdmin() {
  localStorage.removeItem('isAdmin');
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'none';
}
  </script>
</body>
</html>