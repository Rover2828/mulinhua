<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MULINHUA æœ‹å‹åœˆ</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f7f8fa;
      --text-color: #222;
      --card-bg: #fff;
      --header-bg: #fff;
      --border-color: #e0e0e0;
      --primary-color: #1a73e8;
      --hover-color: #155ab6;
      --success-color: #4CAF50;
      --warning-color: #FFC107;
      --error-color: #e53935;
    }

    .dark-mode {
      --bg-color: #121212;
      --text-color: #f0f0f0;
      --card-bg: #1e1e1e;
      --header-bg: #1e1e1e;
      --border-color: #444;
      --primary-color: #64b5f6;
      --hover-color: #90caf9;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    
    header {
      background: var(--header-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.2rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .logo {
      font-weight: 700;
      font-size: 1.5rem;
      letter-spacing: 2px;
      color: var(--primary-color);
    }
    
    .admin-btn, .notify-btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 1rem;
      transition: background 0.2s;
    }
    
    .admin-btn:hover, .notify-btn:hover {
      background: var(--hover-color);
    }
    
    main {
      max-width: 600px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .post {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      margin-bottom: 1.5rem;
      padding: 1.2rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    
    .post-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .post .author {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.1rem;
      cursor: pointer;
    }
    
    .post .time {
      color: #888;
      font-size: 0.85rem;
    }
    
    .post .content {
      font-size: 1.05rem;
      line-height: 1.7;
    }
    
    .post img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 0.5rem;
    }
    
    .post-actions {
      display: flex;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .action-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.9rem;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .action-btn:hover {
      background: rgba(0,0,0,0.05);
    }
    
    .action-btn.liked {
      color: var(--error-color);
    }
    
    .action-btn.faved {
      color: var(--warning-color);
    }
    
    .comments {
      margin-top: 0.8rem;
      border-top: 1px solid var(--border-color);
      padding-top: 0.8rem;
    }
    
    .comment {
      margin-bottom: 0.6rem;
      padding: 0.4rem 0.6rem;
      background: rgba(0,0,0,0.03);
      border-radius: 6px;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    
    .comment-user {
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .comment-time {
      color: #888;
    }
    
    .comment-text {
      margin-top: 4px;
    }
    
    .comment-form {
      display: flex;
      margin-top: 0.8rem;
      gap: 8px;
    }
    
    .comment-input {
      flex-grow: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .comment-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
    }
    
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .filter-btn {
      padding: 6px 12px;
      background: rgba(0,0,0,0.05);
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    .search-bar {
      display: flex;
      margin-bottom: 1.5rem;
    }
    
    .search-input {
      flex-grow: 1;
      padding: 8px 16px;
      border: 1px solid var(--border-color);
      border-radius: 20px 0 0 20px;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .search-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 0 20px 20px 0;
      padding: 8px 16px;
      cursor: pointer;
    }
    
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 99;
    }
    
    @media (max-width: 700px) {
      main { max-width: 100%; }
      header { padding: 1rem; }
      .post-actions { flex-wrap: wrap; }
    }
    
    .admin-panel {
      display: none;
      flex-direction: column;
      gap: 1rem;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .admin-panel input, .admin-panel textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-color);
    }
    
    .admin-panel label {
      font-weight: 600;
      margin-bottom: 0.3rem;
      display: block;
    }
    
    .admin-panel .submit-btn {
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.6rem 1.5rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .admin-panel .submit-btn:hover {
      background: var(--hover-color);
    }
    
    .delete-btn {
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .poll-status {
      position: fixed;
      bottom: 80px;
      right: 20px;
      padding: 8px 15px;
      background: rgba(0,0,0,0.75);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 100;
      display: flex;
      align-items: center;
    }
    
    .poll-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .poll-active { background: var(--success-color); }
    .poll-idle { background: var(--warning-color); }
  </style>
</head>
<body>
  <header>
    <span class="logo">MULINHUA æœ‹å‹åœˆ</span>
    <div>
      <button class="notify-btn" onclick="requestNotify()">
        ğŸ””<span id="notifyCount" style="font-size:0.9em;background:var(--error-color);color:#fff;border-radius:50%;padding:0 6px;margin-left:4px;display:none;">0</span>
      </button>
      <button class="admin-btn" id="memberBtn" onclick="showMemberCenter()">ä¼šå‘˜ä¸­å¿ƒ</button>
      <button class="admin-btn" id="loginBtn" onclick="showUserLoginModal()">ç™»å½•/æ³¨å†Œ</button>
      <button class="admin-btn" id="adminBtn" onclick="showLoginModal()">ç®¡ç†å‘˜å…¥å£</button>
      <button class="admin-btn" id="logoutBtn" style="display:none;" onclick="logoutAdmin()">é€€å‡ºç™»å½•</button>
    </div>
  </header>
  <main>
    <div class="admin-panel" id="adminPanel">
      <form id="postForm" onsubmit="return submitPost(event)">
        <label>å†…å®¹</label>
        <textarea id="postContent" rows="3" required placeholder="è¯·è¾“å…¥å†…å®¹..."></textarea>
        <label>å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
        <input type="file" id="postImage" accept="image/*">
        <button class="submit-btn" type="submit">å‘å¸ƒ</button>
      </form>
      <div style="margin-top:1.2rem;">
        <label>å¯¼å…¥åŠ¨æ€ï¼ˆmmts.txtï¼‰</label>
        <input type="file" id="mmtsFile" accept=".txt" onchange="importMmtsFile(event)">
        <span style="color:#888;font-size:0.95em;">ä»…ç®¡ç†å‘˜å¯ç”¨ï¼Œå†…å®¹æ ¼å¼ä¸ºJSONæ•°ç»„</span>
      </div>
    </div>
    
    <div class="search-bar">
      <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢åŠ¨æ€æˆ–ç”¨æˆ·...">
      <button class="search-btn" onclick="searchPosts()">æœç´¢</button>
    </div>
    
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterFeed('all')">å…¨éƒ¨</button>
      <button class="filter-btn" onclick="filterFeed('following')">å…³æ³¨</button>
      <button class="filter-btn" onclick="filterFeed('popular')">çƒ­é—¨</button>
    </div>
    
    <div id="feed">
      <!-- åŠ¨æ€å†…å®¹æµ -->
    </div>
  </main>
  
  <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
  
  <!-- è½®è¯¢çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div class="poll-status" id="pollStatus">
    <div class="poll-dot poll-active" id="pollDot"></div>
    <span id="pollText">è½®è¯¢ä¸­...</span>
  </div>
  
  <!-- ç”¨æˆ·ç™»å½•/æ³¨å†Œå¼¹çª— -->
  <div id="userLoginModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:101;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">ç”¨æˆ·ç™»å½•/æ³¨å†Œ</div>
      <input id="userLoginUser" type="text" placeholder="ç”¨æˆ·å/æ‰‹æœºå·/é‚®ç®±" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <input id="userLoginPwd" type="password" placeholder="å¯†ç " style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <div id="userLoginError" style="color:var(--error-color);font-size:0.98rem;display:none;"></div>
      <button class="submit-btn" onclick="return userLogin(event)">ç™»å½•</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeUserLoginModal();return false;">å–æ¶ˆ</button>
      <div style="text-align:center;color:#888;font-size:0.98rem;">æˆ–ä½¿ç”¨ç¤¾äº¤è´¦å·ç™»å½•</div>
      <div style="display:flex;gap:1rem;justify-content:center;">
        <button class="submit-btn" style="background:#07c160;" onclick="socialLogin('wechat')">å¾®ä¿¡</button>
        <button class="submit-btn" style="background:#498ad5;" onclick="socialLogin('qq')">QQ</button>
        <button class="submit-btn" style="background:#e6162d;" onclick="socialLogin('weibo')">å¾®åš</button>
      </div>
    </div>
  </div>
  
  <!-- ä¼šå‘˜ä¸­å¿ƒå¼¹çª— -->
  <div id="memberCenterModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:102;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">ä¼šå‘˜ä¸­å¿ƒ</div>
      <div id="memberInfo">è¯·å…ˆç™»å½•</div>
      <div style="margin-top:1rem;">
        <h3>æˆ‘çš„å…³æ³¨</h3>
        <div id="followingList" style="margin-top:0.5rem;"></div>
      </div>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeMemberCenter();return false;">å…³é—­</button>
    </div>
  </div>
  
  <!-- ç®¡ç†å‘˜ç™»å½•å¼¹çª— -->
  <div id="loginModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:100;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:260px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">ç®¡ç†å‘˜ç™»å½•</div>
      <input id="loginUser" type="text" placeholder="è´¦æˆ·" style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <input id="loginPwd" type="password" placeholder="å¯†ç " style="padding:0.7rem;border:1px solid var(--border-color);border-radius:6px;font-size:1rem;background:var(--card-bg);color:var(--text-color);">
      <div id="loginError" style="color:var(--error-color);font-size:0.98rem;display:none;"></div>
      <button class="submit-btn" onclick="return loginAdmin(event)">ç™»å½•</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeLoginModal();return false;">å–æ¶ˆ</button>
    </div>
  </div>
  
  <!-- ç”¨æˆ·èµ„æ–™å¼¹çª— -->
  <div id="userProfileModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:103;align-items:center;justify-content:center;">
    <div style="background:var(--card-bg);padding:2rem 2.2rem;border-radius:12px;box-shadow:0 2px 16px rgba(0,0,0,0.08);min-width:300px;max-width:90vw;display:flex;flex-direction:column;gap:1.2rem;">
      <div style="font-weight:700;font-size:1.2rem;color:var(--primary-color);">ç”¨æˆ·èµ„æ–™</div>
      <div id="profileName"></div>
      <button class="submit-btn" onclick="followUser(currentProfile)">å…³æ³¨</button>
      <button class="submit-btn" style="background:#eee;color:#333;" onclick="closeUserProfile();return false;">å…³é—­</button>
    </div>
  </div>
  
  <script>
    // è½®è¯¢ç›¸å…³å˜é‡
    let pollInterval = null;
    let lastPollTime = Date.now();
    let lastPostCount = 0;
    const POLL_INTERVAL = 10 * 60 * 1000; // 10åˆ†é’Ÿçš„æ¯«ç§’æ•°
    let currentFilter = 'all';
    let filteredPosts = [];
    let currentProfile = null;
    
    // ç¤ºä¾‹åŠ¨æ€æ•°æ®
    let demoPosts = [
      {
        id: 1,
        author: 'ç®¡ç†å‘˜',
        content: 'æ¬¢è¿æ¥åˆ° MULINHUA æœ‹å‹åœˆï¼',
        image: '',
        time: new Date(Date.now() - 300000).toISOString(),
        likes: 12,
        favs: 5
      },
      {
        id: 2,
        author: 'ç®¡ç†å‘˜',
        content: 'æ”¯æŒæ‰‹æœºæ¨é€é€šçŸ¥ï¼Œè®°å¾—ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–æƒé™ã€‚',
        image: '',
        time: new Date(Date.now() - 600000).toISOString(),
        likes: 8,
        favs: 3
      }
    ];
    let lastImportedMmts = '';
    
    // åˆ†é¡µ/æ— é™æ»šåŠ¨å‚æ•°
    let pageSize = 5;
    let currentPage = 1;
    let isLoading = false;
    function getPagedPosts() {
      let posts = getCurrentPosts();
      return posts.slice(0, currentPage * pageSize);
    }
    // è½®è¯¢çŠ¶æ€æ§åˆ¶
    function updatePollStatus(active) {
      const pollDot = document.getElementById('pollDot');
      const pollText = document.getElementById('pollText');
      
      if (active) {
        pollDot.className = 'poll-dot poll-active';
        pollText.textContent = 'è½®è¯¢ä¸­...';
      } else {
        pollDot.className = 'poll-dot poll-idle';
        const elapsed = Math.floor((Date.now() - lastPollTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        pollText.textContent = `${minutes}åˆ†${seconds}ç§’åå°†è½®è¯¢`;
      }
    }
    
    // åˆå§‹åŒ–è½®è¯¢
    function initPolling() {
      lastPostCount = demoPosts.length;
      
      // å¯åŠ¨è½®è¯¢å®šæ—¶å™¨
      pollInterval = setInterval(checkForNewPosts, POLL_INTERVAL);
      updatePollStatus(true);
      
      // é¡µé¢å¯è§æ€§äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
          // é¡µé¢å¯è§æ—¶ç«‹å³æ£€æŸ¥
          checkForNewPosts();
          if (!pollInterval) {
            pollInterval = setInterval(checkForNewPosts, POLL_INTERVAL);
          }
          updatePollStatus(true);
        } else {
          // é¡µé¢ä¸å¯è§æ—¶æš‚åœè½®è¯¢
          clearInterval(pollInterval);
          pollInterval = null;
          updatePollStatus(false);
        }
      });
      
      // åˆå§‹æ£€æŸ¥ä¸€æ¬¡
      checkForNewPosts();
    }
    
    // æ£€æŸ¥æ–°å¸–å­çš„å‡½æ•°
    function checkForNewPosts() {
      lastPollTime = Date.now();
      updatePollStatus(false);
      
      console.log(`[${new Date().toLocaleTimeString()}] è½®è¯¢æ£€æŸ¥æ–°æ¶ˆæ¯...`);
      
      const currentPostCount = demoPosts.length;
      if (currentPostCount > lastPostCount) {
        const newPostCount = currentPostCount - lastPostCount;
        lastPostCount = currentPostCount;
        
        // æ›´æ–°é€šçŸ¥è®¡æ•°
        updateNotifyCount(newPostCount);
        
        // å‘é€é€šçŸ¥
        if (Notification.permission === 'granted') {
          new Notification('æœ‰æ–°åŠ¨æ€å‘å¸ƒ', {
            body: `ç®¡ç†å‘˜å‘å¸ƒäº†${newPostCount}æ¡æ–°æ¶ˆæ¯`,
            icon: '/favicon.ico'
          });
        }
        
        console.log(`æ£€æµ‹åˆ°${newPostCount}æ¡æ–°æ¶ˆæ¯`);
        
        // åˆ·æ–°åŠ¨æ€æµ
        renderFeed();
      } else {
        console.log('æ²¡æœ‰å‘ç°æ–°åŠ¨æ€');
      }
    }
    
    // æ›´æ–°é€šçŸ¥è®¡æ•°
    function updateNotifyCount(count) {
      const notifyCountElement = document.getElementById('notifyCount');
      notifyCountElement.textContent = count;
      notifyCountElement.style.display = count > 0 ? 'inline-block' : 'none';
    }
    
    // ç®¡ç†å‘˜é¢æ¿æ˜¾ç¤º/éšè—
    function toggleAdminPanel() {
      const panel = document.getElementById('adminPanel');
      panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
    }
    
    // è·å–é€šçŸ¥æƒé™
    function requestNotify() {
      if (!('Notification' in window)) {
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
        return;
      }
      
      Notification.requestPermission().then(function(permission) {
        if (permission === 'granted') {
          alert('é€šçŸ¥æƒé™å·²è·å–ï¼');
        } else {
          alert('é€šçŸ¥æƒé™è¢«æ‹’ç»');
        }
      });
    }
    
    // å¯¼å…¥mmts.txtæ–‡ä»¶å¹¶è§£æä¸ºåŠ¨æ€æµ
    function importMmtsFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const txt = evt.target.result;
          if (txt === lastImportedMmts) {
            alert('å†…å®¹æœªå˜åŒ–');
            return;
          }
          const arr = JSON.parse(txt);
          if (!Array.isArray(arr)) throw new Error('æ ¼å¼é”™è¯¯');
          demoPosts = arr;
          lastImportedMmts = txt;
          renderFeed();
          lastPostCount = demoPosts.length;
          if (window.Notification && Notification.permission === 'granted') {
            new Notification('åŠ¨æ€å·²æ›´æ–°', { body: 'å·²å¯¼å…¥æœ€æ–°åŠ¨æ€', icon: '/favicon.ico' });
          }
        } catch (err) {
          alert('mmts.txtæ ¼å¼é”™è¯¯ï¼Œéœ€ä¸ºJSONæ•°ç»„ï¼');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ç®¡ç†å‘˜å‘å¸ƒå†…å®¹
    function submitPost(e) {
      e.preventDefault();
      const content = document.getElementById('postContent').value.trim();
      const imageInput = document.getElementById('postImage');
      if (!content) return false;
      
      function notifyNewPost(text) {
        if (window.Notification && Notification.permission === 'granted') {
          new Notification('æ–°åŠ¨æ€', {
            body: text.length > 40 ? text.slice(0, 40) + '...' : text,
            icon: '/favicon.ico'
          });
        }
      }
      
      const newPost = {
        id: demoPosts.length + 1,
        author: 'ç®¡ç†å‘˜',
        content,
        image: '',
        time: new Date().toISOString(),
        likes: 0,
        favs: 0
      };
      
      if (imageInput.files && imageInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          newPost.image = evt.target.result;
          demoPosts.unshift(newPost);
          renderFeed();
          notifyNewPost(content);
          lastPostCount = demoPosts.length;
          document.getElementById('postForm').reset();
        };
        reader.readAsDataURL(imageInput.files[0]);
      } else {
        demoPosts.unshift(newPost);
        renderFeed();
        notifyNewPost(content);
        lastPostCount = demoPosts.length;
        document.getElementById('postForm').reset();
      }
      
      return false;
    }
    
    // ====== GitHub åŠ¨æ€åŒæ­¥ç›¸å…³ ======
    const GITHUB_OWNER = 'rover2828'; // TODO: æ›¿æ¢ä¸ºä½ çš„githubç”¨æˆ·å
    const GITHUB_REPO = 'mulinhua'; // TODO: æ›¿æ¢ä¸ºä½ çš„ä»“åº“å
    const GITHUB_FILEPATH = 'åŠ¨æ€/mlh.txt';
    const GITHUB_TOKEN = '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'; // TODO: ç®¡ç†å‘˜ç«¯å¡«å†™ä½ çš„tokenï¼Œå‰ç«¯ç”Ÿäº§ç¯å¢ƒè¯·å‹¿æš´éœ²token

    // è·å–åŠ¨æ€ï¼ˆmlh.txtï¼‰
    async function fetchGithubPosts() {
      try {
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}?t=${Date.now()}`;
        const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github.v3.raw' } });
        if (!res.ok) throw new Error('è·å–åŠ¨æ€å¤±è´¥');
        const txt = await res.text();
        const arr = JSON.parse(txt);
        if (Array.isArray(arr)) {
          demoPosts = arr;
          lastImportedMmts = txt;
          filteredPosts = [];
          resetPaging();
          renderFeed();
        }
      } catch (e) {
        alert('æ— æ³•ä»GitHubè·å–åŠ¨æ€ï¼š' + e.message);
      }
    }
    // ç®¡ç†å‘˜å‘å¸ƒå†…å®¹æ—¶åŒæ­¥åˆ°GitHub
    async function pushGithubPosts() {
      if (!GITHUB_TOKEN) return; // æœªé…ç½®tokenä¸æ¨é€
      try {
        // å…ˆè·å–sha
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILEPATH}`;
        const res = await fetch(url, { headers: { 'Authorization': 'token ' + GITHUB_TOKEN } });
        const data = await res.json();
        const sha = data.sha;
        // æ›´æ–°å†…å®¹
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(demoPosts, null, 2))));
        const body = {
          message: 'å‘å¸ƒæ–°åŠ¨æ€',
          content,
          sha
        };
        const putRes = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': 'token ' + GITHUB_TOKEN,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (!putRes.ok) throw new Error('æ¨é€å¤±è´¥');
      } catch (e) {
        alert('åŒæ­¥åˆ°GitHubå¤±è´¥ï¼š' + e.message);
      }
    }
    // ä¿®æ”¹ç®¡ç†å‘˜å‘å¸ƒé€»è¾‘ï¼Œå‘å¸ƒååŒæ­¥
    const originSubmitPost = submitPost;
    submitPost = async function(e) {
      const ret = originSubmitPost(e);
      if (isAdminLoggedIn()) {
        await pushGithubPosts();
      }
      return ret;
    }
    // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½GitHubåŠ¨æ€
    window.addEventListener('DOMContentLoaded', function() {
      fetchGithubPosts();
    });
    // æ·»åŠ åˆ·æ–°æŒ‰é’®
    document.addEventListener('DOMContentLoaded', function() {
      const header = document.querySelector('header > div');
      const refreshBtn = document.createElement('button');
      refreshBtn.className = 'admin-btn';
      refreshBtn.textContent = 'åˆ·æ–°';
      refreshBtn.onclick = function() { fetchGithubPosts(); };
      header.appendChild(refreshBtn);
    });
    
    // æ—¶é—´æ ¼å¼åŒ–
    function formatTime(time) {
      const now = new Date();
      const postDate = new Date(time);
      const diffSec = Math.floor((now - postDate) / 1000);
      
      if (diffSec < 60) return 'åˆšåˆš';
      if (diffSec < 3600) return `${Math.floor(diffSec/60)}åˆ†é’Ÿå‰`;
      if (diffSec < 86400) return `${Math.floor(diffSec/3600)}å°æ—¶å‰`;
      return `${postDate.getMonth()+1}æœˆ${postDate.getDate()}æ—¥`;
    }
    
    // åŠ¨æ€ç­›é€‰
    function filterFeed(type) {
      resetPaging();
      currentFilter = type;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === 
          (type === 'all' ? 'å…¨éƒ¨' : type === 'following' ? 'å…³æ³¨' : 'çƒ­é—¨'));
      });
      
      filteredPosts = [];
      renderFeed();
    }
    
    // æœç´¢åŠŸèƒ½
    function searchPosts() {
      resetPaging();
      const term = document.getElementById('searchInput').value.trim().toLowerCase();
      const feed = document.getElementById('feed');
      if (!term) {
        renderFeed();
        return;
      }
      const keywords = term.split(/\s+/).filter(Boolean);
      const results = demoPosts.filter(post => {
        const text = (post.content + ' ' + post.author + ' ' + (post.comments ? post.comments.map(c => c.text + ' ' + c.user).join(' ') : '')).toLowerCase();
        return keywords.every(kw => text.includes(kw));
      });
      filteredPosts = results;
      renderFeed();
    }
    // é«˜äº®å…³é”®è¯å’Œ@ç”¨æˆ·
    function highlightKeywords(text, keywords) {
      if (!text) return '';
      text = text.replace(/@([\u4e00-\u9fa5\w\-]+)/g, '<span style="color:var(--primary-color);font-weight:bold;">@$1</span>');
      keywords.forEach(kw => {
        if (!kw) return;
        const reg = new RegExp(kw.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'gi');
        text = text.replace(reg, m => `<mark style=\"background:var(--warning-color);color:#222;\">${m}</mark>`);
      });
      return text;
    }
    // è¯„è®ºç‚¹èµ
    function likeComment(postIdx, commentIdx) {
      if (!demoPosts[postIdx].comments[commentIdx].likes) demoPosts[postIdx].comments[commentIdx].likes = 0;
      demoPosts[postIdx].comments[commentIdx].likes++;
      const el = document.getElementById(`comment-like-${demoPosts[postIdx].id}-${commentIdx}`);
      if (el) el.textContent = demoPosts[postIdx].comments[commentIdx].likes;
    }
    // å›¾ç‰‡é¢„è§ˆå¼¹çª—
    function previewImage(src, e) {
      e.stopPropagation();
      let modal = document.getElementById('imgPreviewModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'imgPreviewModal';
        modal.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:200;display:flex;align-items:center;justify-content:center;';
        modal.onclick = function() { modal.style.display = 'none'; };
        document.body.appendChild(modal);
      }
      modal.innerHTML = `<img src='${src}' style='max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 2px 16px #0008;'>`;
      modal.style.display = 'flex';
    }
    // åˆ†é¡µæ¸²æŸ“åŠ¨æ€æµ
    function renderFeed() {
      const feed = document.getElementById('feed');
      let postsToShow = getPagedPosts();
      let keywords = document.getElementById('searchInput').value.trim().toLowerCase().split(/\s+/).filter(Boolean);
      let html = '';
      if (postsToShow.length === 0) {
        html = '<div class="post"><div class="content">æš‚æ— åŠ¨æ€</div></div>';
      } else {
        postsToShow.forEach((post, idx) => {
          const isLiked = localStorage.getItem(`liked_${post.id}`) === 'true';
          const isFaved = localStorage.getItem(`faved_${post.id}`) === 'true';
          let safeImg = post.image ? post.image.replace(/'/g, "&#39;") : '';
          let imageHtml = post.image ? `<img src="${post.image}" style="cursor:zoom-in;" onclick=\"previewImage('${safeImg}', event)\">` : '';
          let content = highlightKeywords(post.content, keywords);
          let author = highlightKeywords(post.author, keywords);
          html += `
            <div class="post">
              <div class="post-header">
                <div class="author" onclick="showUserProfile('${post.author}')">${author}</div>
                <div class="time">${formatTime(post.time)}</div>
              </div>
              <div class="content">${content}</div>
              ${imageHtml}
              <div class="post-actions">
                <button class="action-btn ${isLiked ? 'liked' : ''}" onclick="likePost(${idx})">ğŸ‘ ${post.likes || 0}</button>
                <button class="action-btn ${isFaved ? 'faved' : ''}" onclick="favPost(${idx})">â­ ${post.favs || 0}</button>
                <button class="action-btn" onclick="sharePost(${idx})">â†—ï¸ åˆ†äº«</button>
                ${isAdminLoggedIn() ? `<button class="delete-btn" onclick="deletePost(${idx})">åˆ é™¤</button>` : ''}
              </div>
              ${post.comments && post.comments.length > 0 ? `
                <div class="comments">
                  ${post.comments.map((comment, cidx) => `
                    <div class="comment">
                      <div class="comment-header">
                        <div class="comment-user">${highlightKeywords(comment.user, keywords)}</div>
                        <div class="comment-time">${formatTime(comment.time)}</div>
                        <button class="action-btn comment-like-btn" onclick="likeComment(${idx},${cidx})">ğŸ‘ <span id='comment-like-${post.id}-${cidx}'>${comment.likes||0}</span></button>
                      </div>
                      <div class="comment-text">${highlightKeywords(comment.text, keywords)}</div>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <form class="comment-form" onsubmit="return addComment(event, ${idx})">
                <input type="text" class="comment-input" id="commentInput${idx}" placeholder="æ·»åŠ è¯„è®º...">
                <button type="submit" class="comment-btn">å‘é€</button>
              </form>
            </div>
          `;
        });
      }
      // åŠ è½½æ›´å¤šæŒ‰é’®
      if (getCurrentPosts().length > postsToShow.length) {
        html += `<div style='text-align:center;margin:1rem;'><button class='filter-btn' id='loadMoreBtn' onclick='loadMoreFeed()'>åŠ è½½æ›´å¤š</button></div>`;
      }
      feed.innerHTML = html;
    }
    function loadMoreFeed() {
      if (isLoading) return;
      isLoading = true;
      currentPage++;
      renderFeed();
      isLoading = false;
    }
    // æ— é™æ»šåŠ¨
    window.addEventListener('scroll', function() {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
        if (getCurrentPosts().length > getPagedPosts().length) {
          loadMoreFeed();
        }
      }
    });
    function resetPaging() {
      currentPage = 1;
    }
    // ä¿®æ”¹filterFeedã€setSortã€clearSearchã€showMemberCenterç­‰è°ƒç”¨renderFeedå‰åŠ resetPaging()
    function filterFeed(type) {
      resetPaging();
      currentFilter = type;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === 
          (type === 'all' ? 'å…¨éƒ¨' : type === 'following' ? 'å…³æ³¨' : 'çƒ­é—¨'));
      });
      filteredPosts = [];
      renderFeed();
    }
    function setSort(type) {
      resetPaging();
      currentSort = type;
      renderFeed();
    }
    function clearSearch() {
      resetPaging();
      document.getElementById('searchInput').value = '';
      filteredPosts = [];
      renderFeed();
    }
    function showMemberCenter() {
      resetPaging();
      document.getElementById('memberCenterModal').style.display = 'flex';
      updateMemberInfo();
      updateFollowingList();
    }
    // ç®¡ç†å‘˜ç™»å½•æ ¡éªŒ
function loginAdmin(e) {
  e.preventDefault();
  const user = document.getElementById('loginUser').value.trim();
  const pwd = document.getElementById('loginPwd').value;
  const errorDiv = document.getElementById('loginError');
  if (user === 'rover' && pwd === '1621622968') {
    localStorage.setItem('isAdmin', 'true');
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('logoutBtn').style.display = '';
    document.getElementById('adminPanel').style.display = 'flex';
    errorDiv.style.display = 'none';
    renderFeed && renderFeed();
  } else {
    errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
    errorDiv.style.display = 'block';
  }
  return false;
}
// åˆ¤æ–­æ˜¯å¦å·²ç™»å½•ç®¡ç†å‘˜
function isAdminLoggedIn() {
  return localStorage.getItem('isAdmin') === 'true';
}
function logoutAdmin() {
  localStorage.removeItem('isAdmin');
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('adminPanel').style.display = 'none';
}
  </script>
</body>
</html>